<?php
namespace Heystack\Subsystem\Ecommerce\Transaction;

use Heystack\Subsystem\Core\Storage\Backends\SilverStripeOrm\Backend;
use Heystack\Subsystem\Core\ViewableData\ViewableDataInterface;
use Heystack\Subsystem\Ecommerce\Transaction\Interfaces\TransactionModifierInterface;

/**
 * Generated by PHPUnit_SkeletonGenerator 1.2.0 on 2013-04-25 at 16:59:00.
 */
class TransactionTest extends \PHPUnit_Framework_TestCase
{
    /**
     * @var Transaction
     */
    protected $transaction;

    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     */
    protected function setUp()
    {
        $currencyService = $this->getMockBuilder('Heystack\Subsystem\Ecommerce\Currency\CurrencyService')
            ->disableOriginalConstructor()
            ->getMock();
        $currencyService->expects($this->any())
            ->method('getActiveCurrencyCode')
            ->will($this->returnValue('NZD'));

        $stateService = $this->getMockBuilder('Heystack\Subsystem\Core\State\State')
            ->disableOriginalConstructor()
            ->getMock();

        $modifierIdentifier = $this->getMockBuilder('Heystack\Subsystem\Core\Identifier\Identifier')
            ->disableOriginalConstructor()
            ->getMock();
        $modifierIdentifier->expects($this->any())
            ->method('getFull')
            ->will($this->returnValue('purchasableholder'));

        $modifier = $this->getMock('Heystack\Subsystem\Ecommerce\Transaction\Interfaces\TransactionModifierInterface');
        $modifier->expects($this->any())
            ->method('getIdentifier')
            ->will($this->returnValue($modifierIdentifier));
        $modifier->expects($this->any())
            ->method('getType')
            ->will($this->returnValue('chargeable'));
        $modifier->expects($this->any())
            ->method('getTotal')
            ->will($this->returnValue(100));

        $this->transaction = new Transaction(
            $stateService,
            'Heystack\Subsystem\Ecommerce\Transaction\Collator',
            $currencyService,
            ['Pending', 'Successful', 'Failed', 'Dispatched', 'Processing', 'Cancelled'],
            'Pending'
        );

        $this->transaction->addModifier($modifier);
    }

    /**
     * Tears down the fixture, for example, closes a network connection.
     * This method is called after a test is executed.
     */
    protected function tearDown()
    {
        $this->transaction = null;
    }

    /**
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::__construct
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::addModifier
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::getModifier
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::getModifiers
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::getModifiersByType
     */
    public function testModifiersAccess()
    {
        $modifierIdentifier = $this->getMockBuilder('Heystack\Subsystem\Core\Identifier\Identifier')
            ->disableOriginalConstructor()
            ->getMock();
        $modifierIdentifier->expects($this->any())
            ->method('getFull')
            ->will($this->returnValue('taxhandler'));

        $modifier = $this->getMock('Heystack\Subsystem\Ecommerce\Transaction\Interfaces\TransactionModifierInterface');
        $modifier->expects($this->any())
            ->method('getIdentifier')
            ->will($this->returnValue($modifierIdentifier));
        $modifier->expects($this->any())
            ->method('getType')
            ->will($this->returnValue('deductible'));

        $this->transaction->addModifier($modifier);

        $this->assertTrue($this->transaction->getModifier($modifierIdentifier->getFull()) instanceof TransactionModifierInterface);

        $this->assertContainsOnlyInstancesOf(
            'Heystack\Subsystem\Ecommerce\Transaction\Interfaces\TransactionModifierInterface',
            $this->transaction->getModifiers()
        );

        $this->assertContainsOnlyInstancesOf(
            'Heystack\Subsystem\Ecommerce\Transaction\Interfaces\TransactionModifierInterface',
            $this->transaction->getModifiersByType('deductible')
        );
    }

    /**
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::getTotal
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::updateTotal
     */
    public function testGetTotal()
    {
        $this->assertEquals(0, $this->transaction->getTotal());

        $this->transaction->updateTotal();

        $this->assertEquals(100, $this->transaction->getTotal());

    }

    /**
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::getTotalWithExclusions
     */
    public function testGetTotalWithExclusions()
    {
        $modifierIdentifier = $this->getMockBuilder('Heystack\Subsystem\Core\Identifier\Identifier')
            ->disableOriginalConstructor()
            ->getMock();
        $modifierIdentifier->expects($this->any())
            ->method('getFull')
            ->will($this->returnValue('voucher'));

        $modifier = $this->getMock('Heystack\Subsystem\Ecommerce\Transaction\Interfaces\TransactionModifierInterface');
        $modifier->expects($this->any())
            ->method('getIdentifier')
            ->will($this->returnValue($modifierIdentifier));
        $modifier->expects($this->any())
            ->method('getType')
            ->will($this->returnValue('deductible'));
        $modifier->expects($this->any())
            ->method('getTotal')
            ->will($this->returnValue(50));

        $this->assertEquals(100, $this->transaction->getTotalWithExclusions([]));

        $this->transaction->addModifier($modifier);

        $this->assertEquals(50, $this->transaction->getTotalWithExclusions([]));

        $this->assertEquals(100, $this->transaction->getTotalWithExclusions(['voucher']));

        $this->assertEquals(-50, $this->transaction->getTotalWithExclusions(['purchasableholder']));

    }

    /**
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::getStorableIdentifier
     */
    public function testGetStorableIdentifier()
    {
        $this->assertEquals(Transaction::IDENTIFIER, $this->transaction->getStorableIdentifier());
    }

    /**
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::getSchemaName
     */
    public function testGetSchemaName()
    {
        $this->assertEquals('Transaction', $this->transaction->getSchemaName());
    }

    /**
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::getStorableData
     */
    public function testGetStorableData()
    {
        $storableData = $this->transaction->getStorableData();

        $this->assertCount(3, $storableData);

        $this->assertContains('Transaction', $storableData);
        $this->assertContains('NZD', $storableData['flat']);
        $this->assertContains('Pending', $storableData['flat']);

        $this->assertEquals(0, $storableData['flat']['Total']);

        $this->transaction->updateTotal();
        $storableData = $this->transaction->getStorableData();
        $this->assertEquals(100, $storableData['flat']['Total']);
    }

    /**
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::getStorableBackendIdentifiers
     */
    public function testGetStorableBackendIdentifiers()
    {
        $this->assertEquals([Backend::IDENTIFIER], $this->transaction->getStorableBackendIdentifiers());
    }

    /**
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::getCollator
     */
    public function testGetCollator()
    {
        $this->assertTrue($this->transaction->getCollator() instanceof ViewableDataInterface);
    }

    /**
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::setStatus
     * @covers Heystack\Subsystem\Ecommerce\Transaction\Transaction::getStatus
     */
    public function testSetStatus()
    {
        $this->transaction->setStatus('invalid_status');
        $this->assertFalse('invalid_status' === $this->transaction->getStatus());
        $this->assertEquals('Pending', $this->transaction->getStatus());

        $this->transaction->setStatus('Successful');
        $this->assertEquals('Successful', $this->transaction->getStatus());
    }
}
